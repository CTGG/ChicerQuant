var app=angular.module("singleStrategy",[]);app.controller("kLine",function(a,b){a.test=function(g){var i=a.stockid;var d=new Date();var f=d.getFullYear();var h=d.getMonth()+1;var c=d.getDate();var e=f+"-"+(h-1)+"-"+c;if(h-1==0){e=(f-1)+"-12-"+c}if(i==undefined){i="sh600315"}if(localStorage.latestDate==undefined){localStorage.latestDate=f+"-"+h+"-"+c}a.url="http://115.159.97.98/php/serviceController.php";b.post(a.url,{method:"getPolyAmongDateService",startdate:e,enddate:localStorage.latestDate,name:i}).success(function(k,j){var m=[];var l=[];for(obj in k){if(obj!="retmsg"){l.push(k[obj]["date"]);m.push(k[obj]["poly"])}}g=g.slice(30-m.length+1,30);a.polyoption={title:{left:"center",text:"Poly Line Chart"},legend:{top:"bottom",data:["poly","real close"]},tooltip:{trigger:"axis",axisPointer:{animation:true}},toolbox:{show:true,feature:{dataView:{show:true,readOnly:false},magicType:{show:true,type:["line","bar","stack","tiled"]},restore:{show:true},saveAsImage:{show:true}}},xAxis:{type:"category",boundaryGap:false,data:l},yAxis:{type:"value",boundaryGap:false},series:[{name:"poly",type:"line",smooth:true,data:m},{name:"real close",type:"line",smooth:true,data:g}]};var n=echarts.init(document.getElementById("poly"));n.setOption(a.polyoption)}).error(function(){alert("net error")})};a.change=function(){a.url="http://115.159.97.98/php/serviceController.php";var g=a.stockid;var d=new Date();var e=d.getFullYear();var f=d.getMonth()+1;var c=d.getDate();b.post(a.url,{method:"getStockAmongDateService",startdate:(e)+"-"+(f-4)+"-"+c,enddate:e+"-"+f+"-"+c,name:g}).success(function(l,n){var k=q(l);var h=[];for(var o=k.values.length-30;o<k.values.length;o++){h.push(k.values[o][1])}a.lastmonthclose=h;var m=l["0"]["stock_name"];function q(t){var i=[];var r=[];for(obj in t){if(obj!="retmsg"){i.push(t[obj]["date"]);var s=[];s.push(t[obj]["open"]);s.push(t[obj]["close"]);s.push(t[obj]["low"]);s.push(t[obj]["high"]);r.push(s)}}return{categoryData:i,values:r}}function j(w){var s=[];for(var u=0,r=k.values.length;u<r;u++){if(u<w){s.push("-");continue}var v=0;for(var t=0;t<w;t++){v+=Number(k.values[u-t][1])}s.push(v/w)}return s}a.klineoption={title:{text:m,left:0},tooltip:{trigger:"axis",axisPointer:{type:"line"}},legend:{data:["日K","MA5","MA10","MA20","MA30"]},grid:{left:"10%",right:"10%",bottom:"15%"},xAxis:{type:"category",data:k.categoryData,scale:true,boundaryGap:false,axisLine:{onZero:false},splitLine:{show:false},splitNumber:5,min:"dataMin",max:"dataMax"},yAxis:{scale:true,splitArea:{show:true}},dataZoom:[{type:"inside",start:50,end:100},{show:true,type:"slider",y:"90%",start:50,end:100}],series:[{name:"日K",type:"candlestick",data:k.values},{name:"MA5",type:"line",data:j(5),smooth:true,lineStyle:{normal:{opacity:0.5}}},{name:"MA10",type:"line",data:j(10),smooth:true,lineStyle:{normal:{opacity:0.5}}},{name:"MA20",type:"line",data:j(20),smooth:true,lineStyle:{normal:{opacity:0.5}}},{name:"MA30",type:"line",data:j(30),smooth:true,lineStyle:{normal:{opacity:0.5}}}]};var p=echarts.init(document.getElementById("kline"));p.setOption(a.klineoption);a.test(h)}).error(function(){alert("net error")})};a.stockid="sh600310";a.change()});